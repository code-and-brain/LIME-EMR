name: Build and Push Docker Images

on:
  push:
    branches: [ main, LIME2-666 ]
    tags: [ 'v*' ]
  workflow_dispatch:
    inputs:
      image:
        description: 'Specific image to build (optional)'
        required: false
        default: 'all'
      tag:
        description: 'Docker tag to use'
        required: false
        default: 'latest'
      force_rebuild:
        description: 'Force rebuild all images (ignores docker-build.txt)'
        required: false
        type: boolean
        default: false

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ${{ github.repository_owner }}/ozone-msf-mosul

jobs:
  maven-build:
    permissions: 
      contents: read
      packages: write
    runs-on: ubuntu-latest
    strategy:
      matrix:
        java: [ '8' ]
    outputs:
      build-artifacts: ${{ steps.build.outputs.build-artifacts }}
      version: ${{ steps.build.outputs.version }}
      artifactid: ${{ steps.build.outputs.artifactid }}
    steps:
      - name: System Cleanup - Prevent Inode Exhaustion
        run: |
          echo "ðŸ”§ Starting system cleanup to prevent inode exhaustion..."
          
          # Display current disk and inode usage
          echo "ðŸ“Š Current disk usage:"
          df -h
          echo ""
          echo "ðŸ“Š Current inode usage:"
          df -i
          echo ""
          
          # Function to safely clean directory
          cleanup_directory() {
            local dir="$1"
            local description="$2"
            local max_files="${3:-1000}"
            
            if [ -d "$dir" ]; then
              local file_count=$(find "$dir" -type f 2>/dev/null | wc -l)
              echo "ðŸ“ $description: $file_count files"
              
              if [ "$file_count" -gt "$max_files" ]; then
                echo "âš ï¸  Too many files in $dir ($file_count > $max_files), cleaning up..."
                
                # Remove files older than 7 days
                find "$dir" -type f -mtime +7 -delete 2>/dev/null || true
                
                # If still too many files, remove older than 3 days
                local remaining=$(find "$dir" -type f 2>/dev/null | wc -l)
                if [ "$remaining" -gt "$max_files" ]; then
                  echo "ðŸ§¹ Still too many files, removing files older than 3 days..."
                  find "$dir" -type f -mtime +3 -delete 2>/dev/null || true
                fi
                
                # If still too many, remove all but the 500 newest files
                local final_count=$(find "$dir" -type f 2>/dev/null | wc -l)
                if [ "$final_count" -gt "$max_files" ]; then
                  echo "ðŸ§¹ Emergency cleanup: keeping only 500 newest files..."
                  find "$dir" -type f -printf '%T@ %p\n' 2>/dev/null | sort -nr | tail -n +501 | cut -d' ' -f2- | xargs -r rm -f
                fi
                
                local after_count=$(find "$dir" -type f 2>/dev/null | wc -l)
                echo "âœ… Cleanup complete: $file_count â†’ $after_count files"
              else
                echo "âœ… $description is healthy"
              fi
            else
              echo "â„¹ï¸  $description does not exist"
            fi
            echo ""
          }
          
          # Clean up common problematic directories
          cleanup_directory "/home/runner/actions-runner/cached/_diag" "GitHub Runner diagnostics" 500
          cleanup_directory "/home/runner/actions-runner/cached/_work" "GitHub Runner work cache" 2000
          cleanup_directory "/tmp" "Temporary files" 5000
          cleanup_directory "/var/tmp" "Variable temporary files" 1000
          cleanup_directory "/home/runner/.cache" "User cache" 3000
          
          # Clean up Docker if it exists
          if command -v docker >/dev/null 2>&1; then
            echo "ðŸ³ Docker cleanup:"
            docker system prune -f --volumes 2>/dev/null || true
            docker image prune -a -f 2>/dev/null || true
            echo "âœ… Docker cleanup complete"
            echo ""
          fi
          
          # Clean up package manager caches
          echo "ðŸ“¦ Package manager cleanup:"
          sudo apt-get clean 2>/dev/null || true
          sudo apt-get autoclean 2>/dev/null || true
          sudo apt-get autoremove -y 2>/dev/null || true
          echo "âœ… Package cleanup complete"
          echo ""
          
          # Remove old log files system-wide (be careful with this)
          echo "ðŸ“ System log cleanup:"
          sudo find /var/log -type f -name "*.log" -mtime +7 -delete 2>/dev/null || true
          sudo find /var/log -type f -name "*.log.*" -mtime +7 -delete 2>/dev/null || true
          echo "âœ… System log cleanup complete"
          echo ""
          
          # Clean up npm cache if Node.js is installed
          if command -v npm >/dev/null 2>&1; then
            echo "ðŸ“¦ NPM cache cleanup:"
            npm cache clean --force 2>/dev/null || true
            echo "âœ… NPM cache cleanup complete"
            echo ""
          fi
          
          # Clean up pip cache if Python is installed
          if command -v pip >/dev/null 2>&1; then
            echo "ðŸ Python pip cache cleanup:"
            pip cache purge 2>/dev/null || true
            echo "âœ… Python cache cleanup complete"
            echo ""
          fi
          
          # Final status report
          echo "ðŸŽ¯ Final system status:"
          echo "ðŸ“Š Disk usage after cleanup:"
          df -h
          echo ""
          echo "ðŸ“Š Inode usage after cleanup:"
          df -i
          echo ""
          
          # Check if we're still at risk
          root_inode_usage=$(df -i | grep -E '/$' | awk '{print $5}' | sed 's/%//')
          if [ "$root_inode_usage" -gt 80 ]; then
            echo "âš ï¸  WARNING: Root inode usage is still high ($root_inode_usage%)"
            echo "ðŸ” Top directories by file count:"
            find / -xdev -type d -exec bash -c 'echo "$(find "$1" -maxdepth 1 | wc -l) $1"' _ {} \; 2>/dev/null | sort -nr | head -10
          else
            echo "âœ… System is healthy - inode usage: $root_inode_usage%"
          fi
          
          echo "ðŸŽ‰ System cleanup completed successfully!"

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Set up JDK ${{ matrix.java }}
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ matrix.java }}
          cache: 'maven'

      - name: Set settings.xml
        uses: s4u/maven-settings-action@v3.1.0
        with:
          servers: '[{"id": "msf-ocg-github-lime-emr", "username": "${{ secrets.MAVEN_GITHUB_ACTIONS_DEPLOY_USERNAME }}", "password": "${{ secrets.MAVEN_GITHUB_ACTIONS_DEPLOY_TOKEN }}"}]'
            
      - name: Build and Test
        id: build
        run: |
          set -euo pipefail
          
          # Validate Maven wrapper
          if [ ! -x "./scripts/mvnw" ]; then
            echo "::error::Maven wrapper not found or not executable"
            exit 1
          fi

          # Get Mosul version and artifact ID
          echo "Fetching Mosul project info..."
          cd sites/mosul
          VERSION=$(./../../scripts/mvnw help:evaluate -Dexpression=project.version -q -DforceStdout)
          ARTIFACTID=$(./../../scripts/mvnw help:evaluate -Dexpression=project.artifactId -q -DforceStdout)
          cd ../..
          
          echo "Mosul Artifact: $ARTIFACTID, Version: $VERSION"
          
          # Run build
          ./scripts/mvnw --batch-mode --update-snapshots --activate-profiles validator -Pbundled-docker -Pazure clean package
          
          # Verify and copy Mosul distro
          MOSUL_DISTRO="sites/mosul/target/$ARTIFACTID-$VERSION/distro"
          TARGET_DIR="distro/target/bundled-docker-build-tmp/distro"
          
          if [ ! -d "$MOSUL_DISTRO" ]; then
            echo "::error::Mosul distro directory not found at $MOSUL_DISTRO"
            exit 1
          fi
          
          echo "Copying Mosul distro to $TARGET_DIR"
          mkdir -p "$TARGET_DIR"
          cp -R "$MOSUL_DISTRO"/* "$TARGET_DIR"/
          
          # Verify final build output
          if [ ! -d "distro/target/bundled-docker-build-tmp" ]; then
            echo "::error::Maven build output directory not found"
            exit 1
          fi
          
          echo "Maven build successful - bundled-docker-build-tmp generated"
          echo "build-artifacts=success" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "artifactid=$ARTIFACTID" >> $GITHUB_OUTPUT
          
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: bundled-docker-build-tmp
          path: distro/target/bundled-docker-build-tmp
          retention-days: 1
        if: ${{ steps.build.outputs.build-artifacts == 'success' }}

  setup:
    runs-on: ubuntu-latest
    needs: maven-build
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
      build_list: ${{ steps.set-matrix.outputs.build_list }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: bundled-docker-build-tmp
          path: .
        if: ${{ needs.maven-build.outputs.build-artifacts == 'success' }}

      - name: Verify build artifacts
        run: |
          set -euo pipefail
          if [ ! -d "bundled-docker-build-tmp" ]; then
            echo "::error::Build artifacts not found"
            exit 1
          fi
          
          if [ ! -d "bundled-docker-build-tmp/bundled-docker" ]; then
            echo "::error::bundled-docker directory not found in artifacts"
            exit 1
          fi
          
          echo "Build artifacts verified successfully"
          
      - name: Determine images to build
        id: set-matrix
        run: |
          set -euo pipefail
          
          # Image name mapping (directory -> image name)
          declare -A IMAGE_MAPPING=(
            ["mysql"]="mysql"
            ["postgresql"]="postgresql"
            ["odoo"]="odoo"
            ["eip-odoo-openmrs"]="eip-odoo-openmrs"
            ["openmrs"]="openmrs-backend"
            ["frontend"]="openmrs-frontend"
            ["senaite"]="senaite"
            ["eip-openmrs-senaite"]="eip-openmrs-senaite"
            ["proxy"]="proxy"
          )
          
          # Initialize variables
          SPECIFIC_IMAGE="${{ github.event.inputs.image }}"
          FORCE_REBUILD="${{ github.event.inputs.force_rebuild }}"
          BUILD_DIRS=""
          
          # Get default build directories if docker-build.txt exists
          if [ "$FORCE_REBUILD" != "true" ] && [ -f "docker-build.txt" ]; then
            BUILD_DIRS=$(grep -v '^#' docker-build.txt | grep -v '^[[:space:]]*$' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//' || echo "")
          fi
          
          # Handle specific image request
          if [ "$SPECIFIC_IMAGE" != "all" ] && [ -n "$SPECIFIC_IMAGE" ]; then
            for dir in "${!IMAGE_MAPPING[@]}"; do
              if [ "${IMAGE_MAPPING[$dir]}" = "$SPECIFIC_IMAGE" ]; then
                if [ -d "bundled-docker-build-tmp/bundled-docker/$dir" ]; then
                  echo "matrix={\"include\":[{\"context\":\"bundled-docker-build-tmp/bundled-docker/$dir\",\"image\":\"$SPECIFIC_IMAGE\",\"dockerfile\":\"Dockerfile\"}]}" >> $GITHUB_OUTPUT
                  echo "build_list=$SPECIFIC_IMAGE" >> $GITHUB_OUTPUT
                  exit 0
                else
                  echo "::error::Directory for image '$SPECIFIC_IMAGE' not found in artifacts"
                  exit 1
                fi
              fi
            done
            echo "::error::Image '$SPECIFIC_IMAGE' not found in mapping"
            exit 1
          fi
          
          # Handle force rebuild or normal case
          MATRIX_ENTRIES=()
          BUILD_LIST=()
          
          if [ "$FORCE_REBUILD" = "true" ] || [ -z "$BUILD_DIRS" ]; then
            # Build all available images
            echo "Building all available images"
            for dir in "${!IMAGE_MAPPING[@]}"; do
              if [ -d "bundled-docker-build-tmp/bundled-docker/$dir" ]; then
                MATRIX_ENTRIES+=("{\"context\":\"bundled-docker-build-tmp/bundled-docker/$dir\",\"image\":\"${IMAGE_MAPPING[$dir]}\",\"dockerfile\":\"Dockerfile\"}")
                BUILD_LIST+=("${IMAGE_MAPPING[$dir]}")
              fi
            done
          else
            # Build only images from docker-build.txt
            while IFS= read -r dir; do
              if [ -n "$dir" ]; then
                if [ ! -d "bundled-docker-build-tmp/bundled-docker/$dir" ]; then
                  echo "::error::Directory 'bundled-docker-build-tmp/bundled-docker/$dir' not found"
                  exit 1
                fi
                
                if [ -z "${IMAGE_MAPPING[$dir]}" ]; then
                  echo "::error::Directory '$dir' not found in image mapping"
                  exit 1
                fi
                
                MATRIX_ENTRIES+=("{\"context\":\"bundled-docker-build-tmp/bundled-docker/$dir\",\"image\":\"${IMAGE_MAPPING[$dir]}\",\"dockerfile\":\"Dockerfile\"}")
                BUILD_LIST+=("${IMAGE_MAPPING[$dir]}")
              fi
            done <<< "$BUILD_DIRS"
          fi
          
          # Output results
          MATRIX_STR=$(IFS=, ; echo "${MATRIX_ENTRIES[*]}")
          BUILD_STR=$(IFS=, ; echo "${BUILD_LIST[*]}")
          
          echo "matrix={\"include\":[$MATRIX_STR]}" >> $GITHUB_OUTPUT
          echo "build_list=$BUILD_STR" >> $GITHUB_OUTPUT

  build:
    runs-on: ubuntu-latest
    needs: [maven-build, setup]
    strategy:
      matrix: ${{ fromJson(needs.setup.outputs.matrix) }}
      fail-fast: false
    permissions:
      packages: write
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: bundled-docker-build-tmp
          path: .
        if: ${{ needs.maven-build.outputs.build-artifacts == 'success' }}

      - name: Verify Docker context exists
        run: |
          set -euo pipefail
          if [ ! -d "${{ matrix.context }}" ]; then
            echo "::error::Docker context directory '${{ matrix.context }}' not found"
            exit 1
          fi
          
          if [ ! -f "${{ matrix.context }}/${{ matrix.dockerfile }}" ]; then
            echo "::error::Dockerfile not found in context directory"
            exit 1
          fi
          
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-${{ matrix.image }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=raw,value=latest,enable={{is_default_branch}}
            
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: ${{ matrix.context }}
          file: ${{ matrix.context }}/${{ matrix.dockerfile }}
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64,linux/arm64

      - name: Output image info
        run: |
          echo "Built and pushed: ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-${{ matrix.image }}"
          echo "Tags: ${{ steps.meta.outputs.tags }}"
          
  summary:
    runs-on: ubuntu-latest
    needs: [maven-build, setup, build]
    if: always()
    steps:
      - name: Generate build summary
        env:
          BUILD_LIST: ${{ needs.setup.outputs.build_list }}
        run: |
          echo "## Docker Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Job status function
          job_status() {
            case "$1" in
              "success") echo "âœ… Success" ;;
              "failure") echo "âŒ Failed" ;;
              "cancelled") echo "âš ï¸ Cancelled" ;;
              "skipped") echo "âš ï¸ Skipped" ;;
              *) echo "â“ Unknown ($1)" ;;
            esac
          }
          
          # Show Maven and Setup status
          echo "**Maven Build**: $(job_status "${{ needs.maven-build.result }}")" >> $GITHUB_STEP_SUMMARY
          echo "**Setup**: $(job_status "${{ needs.setup.result }}")" >> $GITHUB_STEP_SUMMARY
          
          # Show configuration source
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ github.event.inputs.force_rebuild }}" = "true" ]; then
            echo "**Configuration**: Force rebuild mode (all available images)" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ github.event.inputs.image }}" != "all" ] && [ -n "${{ github.event.inputs.image }}" ]; then
            echo "**Configuration**: Manual build - ${{ github.event.inputs.image }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Configuration**: $([ -f "docker-build.txt" ] && echo "docker-build.txt" || echo "Default image list (docker-build.txt not found)")" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Show image build status
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Image | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.maven-build.result }}" != "success" ]; then
            echo "| All images | âŒ Maven build failed |" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.setup.result }}" != "success" ]; then
            echo "| All images | âŒ Setup failed |" >> $GITHUB_STEP_SUMMARY
          elif [ -n "$BUILD_LIST" ]; then
            IFS=',' read -ra IMAGES <<< "$BUILD_LIST"
            for image in "${IMAGES[@]}"; do
              if [ -n "$image" ]; then
                echo "| $image | $(job_status "${{ needs.build.result }}") |" >> $GITHUB_STEP_SUMMARY
              fi
            done
          else
            echo "| No images configured | âš ï¸ No builds |" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Show additional info
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Registry:** ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "**Manual trigger:** ${{ github.event.inputs.image }}" >> $GITHUB_STEP_SUMMARY
            [ "${{ github.event.inputs.force_rebuild }}" = "true" ] && echo "**Force rebuild:** Enabled" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Show docker-build.txt if exists
          if [ -f "docker-build.txt" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Current docker-build.txt Configuration" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat docker-build.txt >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi
          
